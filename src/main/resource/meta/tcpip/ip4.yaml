# Sly Technologies Free License
# 
# Copyright 2025 Sly Technologies Inc.
#
# This YAML file defines the IPv4 protocol meta-template structure used for packet 
# analysis and display. The template provides Field definitions, formatting rules,
# and display configurations for various protocol fields including version, Header
# length, traffic class, fragmentation, and options.
#
# The template supports multiple detail levels (HIGH, MEDIUM, SUMMARY) with 
# inheritance, allowing for different views of the same packet data. It uses
# a flexible macro system for bit-Field definitions and includes defaults for
# consistent formatting across all detail levels.

Overview:
  description: >
    Defines templates and structures for IPv4 protocol data formatting and analysis.

Defaults:
  indent: 4
  width: 64
  align: left

Macros:
  $ip_ver:    "/1111 ..../"
  $ip_hlen:   "/.... 1111/"
  $ip_flag:   "/111. ..../"
  $ip_res:    "/.1.. ..../"
  $ip_df:     "/..1. ..../"
  $ip_offset: "/...1 1111 1111 1111/"
  $is_set:    "is_set"
  $ip_type:   "IP_TYPE"

Templates:
  - Header: Ip4
    class: com.slytechs.jnet.protocol.tcpip.ip.Ip4
    Imports:
      - "/tcpip/ip4-options.yaml#IPv4-OPT-RT-ALERT"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-MTU-PROBE"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-MTU-REPLY"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-SEC"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-QUICK"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-TRACE"

    Details:
      - Detail: high
        summary: 'Internet Protocol Version 4, offset=\{offset} length=\{length}'
        Defaults:
          - width: 4
        Items:
          - Field: version
            template: '\{Header[0]:$ip_ver} = Version: \{value}'
            Tags: [important, frame]

          - Field: hdrLen
            template: '\{Header[0]:$ip_hlen} = Header Length: \{:bytes *= 4} (\{value})'
            Tags: [important, frame]

          - Field: trafficClass
            label: "Traffic Class"
            template: '\{:0x%02x} (DSCP: \{trafficDscpName}, ECN: \{trafficDscpAbbr})'

          - Field: totalLength
            label: "Total Length" 
            template: '\{:bytes}'

          - Field: identification
            label: "Identification"
            template: '\{:0x%04x} (\{value})'

          - Field: flags
            label: "Flags"
            template: '\{:$ip_flag <<= 5} = Flags: \{:0x%X}, \{flagsInfo}'
            Items:
              - template: '\{:/1... ..../} = Reserved bit: \{:$is_set}'
              - template: '\{:/.1.. ..../} = Don''t fragment: \{:$is_set}'
              - template: '\{:/..1. ..../} = More fragments: \{:$is_set}'
            Defaults:
              indent: 0

          - Field: fragOffset
            template: '\{:$ip_offset} = Fragment Offset: \{fragOffset}'

          - Field: ttl
            label: "Time to Live"
            template: '\{value}'

          - Field: protocol
            label: "Protocol"
            template: '\{:$ip_type} (\{value})'

          - Field: src
            label: "Source Address"
            template: '\{value}'

          - Field: dst
            label: "Destination Address"
            template: '\{value}'

          - Field: options
            label: "IPv4 Options"
            Items:
              - Header: Ip4RouterAlertOption
                summary: 'Router Alert (\{length:bytes}): \{routerAlertDescription}'

              - Header: Ip4MtuProbeOption
                summary: 'MTU Probe (\{length:bytes})'

              - Header: Ip4MtuReplyOption
                repeatable: true
                summary: 'MTU Reply (\{length:bytes})'

              - Header: Ip4SecurityDefunctOption
                summary: 'Security (\{length:bytes}): \{securityLevel}'

              - Header: Ip4QuickStartOption
                repeatable: true
                summary: 'Quick Start (\{length:bytes})'

              - Header: Ip4TracerouteOption
                repeatable: true
                summary: 'Trace Route (\{length:bytes})'

      - Detail: medium
        summary: 'IPv4 \{src} → \{dst} (\{protocol})'
        Items:
          - Field: trafficClass
            label: "Traffic Class"
            template: '\{:0x%02x} (DSCP: \{trafficDscpName}, ECN: \{trafficDscpAbbr})'

          - Field: totalLength
            label: "Total Length"
            template: '\{:bytes}'

          - Field: ttl
            label: "Time to Live"
            template: '\{value}'

          - Field: protocol
            label: "Protocol"
            template: '\{:$ip_type}'

      - Detail: summary
        summary: 'IPv4 \{src} → \{dst} (\{protocol})'
