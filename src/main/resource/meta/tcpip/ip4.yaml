# Sly Technologies Free License
# 
# Copyright 2025 Sly Technologies Inc.
#
# This YAML file defines the IPv4 protocol meta-template structure used for packet 
# analysis and display. The template provides field definitions, formatting rules,
# and display configurations for various protocol fields including version, header
# length, traffic class, fragmentation, and options.
#
# The template supports multiple detail levels (HIGH, MEDIUM, SUMMARY) with 
# inheritance, allowing for different views of the same packet data. It uses
# a flexible macro system for bit-field definitions and includes defaults for
# consistent formatting across all detail levels.

description: >
    Defines templates and structures for IPv4 protocol data formatting and analysis.

defaults:
  indent: 4
  width: 64
  align: left

macros:
  $ip_ver:    "/1111 ..../"
  $ip_hlen:   "/.... 1111/"
  $ip_flag:   "/111. ..../"
  $ip_res:    "/.1.. ..../"
  $ip_df:     "/..1. ..../"
  $ip_offset: "/...1 1111 1111 1111/"
  $is_set:    "is_set"
  $ip_type:   "IP_TYPE"

Templates:
  - header: Ip4
    class: com.slytechs.jnet.protocol.tcpip.ip.Ip4
    imports:
      - "/tcpip/ip4-options.yaml#IPv4-OPT-RT-ALERT"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-MTU-PROBE"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-MTU-REPLY"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-SEC"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-QUICK"
      - "/tcpip/ip4-options.yaml#IPv4-OPT-TRACE"

    details:
      - detail: HIGH
        summary: 'Internet Protocol Version 4, offset=\{offset} length=\{length}'
        defaults:
          - width: 4
        items:
          - field: version
            template: '\{header[0]:$ip_ver} = Version: \{value}'
            tags: [important, frame]

          - field: hdrLen
            template: '\{header[0]:$ip_hlen} = Header Length: \{:bytes *= 4} (\{value})'
            tags: [important, frame]

          - field: trafficClass
            label: "Traffic Class"
            template: '\{:0x%02x} (DSCP: \{trafficDscpName}, ECN: \{trafficDscpAbbr})'

          - field: totalLength
            label: "Total Length" 
            template: '\{:bytes}'

          - field: identification
            label: "Identification"
            template: '\{:0x%04x} (\{value})'

          - field: flags
            label: "Flags"
            summary: '\{:$ip_flag <<= 5} = Flags: \{:0x%X}, \{flagsInfo}'
            defaults:
              indent: 0
            items:
              - template: '\{:/1... ..../} = Reserved bit: \{:$is_set}'
              - template: '\{:/.1.. ..../} = Don''t fragment: \{:$is_set}'
              - template: '\{:/..1. ..../} = More fragments: \{:$is_set}'

          - field: fragOffset
            template: '\{:$ip_offset} = Fragment Offset: \{fragOffset}'

          - field: ttl
            label: "Time to Live"
            template: '\{value}'

          - field: protocol
            label: "Protocol"
            template: '\{:$ip_type} (\{value})'

          - field: src
            label: "Source Address"
            template: '\{value}'

          - field: dst
            label: "Destination Address"
            template: '\{value}'

          - field: options
            label: "IPv4 Options"
            items:
              - header: Ip4RouterAlertOption
                summary: 'Router Alert (\{length:bytes}): \{routerAlertDescription}'

              - header: Ip4MtuProbeOption
                summary: 'MTU Probe (\{length:bytes})'

              - header: Ip4MtuReplyOption
                repeatable: true
                summary: 'MTU Reply (\{length:bytes})'

              - header: Ip4SecurityDefunctOption
                summary: 'Security (\{length:bytes}): \{securityLevel}'

              - header: Ip4QuickStartOption
                repeatable: true
                summary: 'Quick Start (\{length:bytes})'

              - header: Ip4TracerouteOption
                repeatable: true
                summary: 'Trace Route (\{length:bytes})'

      - detail: MEDIUM
        summary: 'IPv4 \{src} → \{dst} (\{protocol})'
        items:
          - field: trafficClass
            label: "Traffic Class"
            template: '\{:0x%02x} (DSCP: \{trafficDscpName}, ECN: \{trafficDscpAbbr})'

          - field: totalLength
            label: "Total Length"
            template: '\{:bytes}'

          - field: ttl
            label: "Time to Live"
            template: '\{value}'

          - field: protocol
            label: "Protocol"
            template: '\{:$ip_type}'

      - detail: SUMMARY
        summary: 'IPv4 \{src} → \{dst} (\{protocol})'
